<html>
    <head>
        <title>
           <%= t('appTitle') %>
        </title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" href="/stylesheets/main.css">
    </head>
    <body>

    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="/"><%= t('navBrand') %></a>
            </div>
    
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <% if (!user) { %>
                        <li><a href="/login?lang=<%= lang %>"><%= t('navLogin') %></a></li>
                        <li><a href="/register?lang=<%= lang %>"><%= t('navRegister') %></a></li>
                    <% } else { %>
                        <li>
                            <a>
                                <%= user.username %>
                                <% if (user.role === "admin") { %>
                                    <span class="label label-warning" style="margin-left:4px;"><%= t('adminBadge') %></span>
                                <% } %>
                            </a>
                        </li>
                        <% if (user.role === "admin") { %>
                            <li><a href="/admin/users?lang=<%= lang %>"><%= t('adminUserMenu') %></a></li>
                        <% } %>
                        <li><a href="/logout?lang=<%= lang %>"><%= t('navLogout') %></a></li>
                    <% } %>

                    <!-- 语言切换 -->
                    <li>
                        <%
                           var fullPath = '/';
                           if (typeof request !== 'undefined' && request) {
                               fullPath = (request.baseUrl || '') + (request.path || '/');
                           }
                           var returnParam = encodeURIComponent(fullPath);
                        %>
                        <form method="GET" action="<%= fullPath %>" style="margin-top:8px; display:flex; align-items:center;">
                            <span style="margin-right:4px;"><%= t('langLabel') %>:</span>
                            <select name="lang" onchange="handleLangChange(this, '<%= fullPath %>', '<%= returnParam %>')" class="form-control input-sm" style="width:auto; display:inline-block;">
                                <% for (var code in allLangs) { %>
                                    <option value="<%= code %>" <%= code === lang ? 'selected' : '' %>>
                                        <%= allLangs[code] %>
                                    </option>
                                <% } %>
                            </select>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <script>
        function handleLangChange(selectEl, fullPath, returnParam) {
            var value = selectEl.value;
            if (value === "__more__") {
                window.location.href = "/languages?return=" + returnParam;
            } else {
                // 提交原有表单，附带 lang 参数
                selectEl.form.submit();
            }
        }
    </script>

   <div class="container">
       <% if (error && error.length>0){ %>
            <div class="alert alert-danger">
                <%= error %>
            </div>
       <% } %>

       <% if (success && success.length>0){ %>
            <div class="alert alert-info">
                <%= success %>
            </div>
       <% } %>
   </div>
